---
title: "ProyectoTD2024"
author: Sergio Taengua Díaz, Valentina Elisa Medina Gallazzi, Narcis Casian Romega,
  Sheida Zolfaghari
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

# 1 Introducción

En la era actual, donde la digitalización y la sostenibilidad son de suma importancia, la implementación de tickets electrónicos por parte de un conocido supermercado representa un avance significativo. Este cambio no solo promueve la reducción del uso de papel, sino que también abre un nuevo horizonte de posibilidades en el análisis de datos de consumo. Como estudiantes del GCD, nos enfrentamos al desafío de desarrollar un programa que no solo simplifique la transición a lo digital, sino que también permita un análisis exhaustivo de los hábitos de compra.

Nuestro objetivo es crear una herramienta que analice los tickets electrónicos para obtener información valiosa sobre la evolución de precios, las compras más habituales, los productos más consumidos, el supermercado preferido por los clientes y la hora de compra, entre otros aspectos. Este análisis no solo beneficiará a los consumidores, quienes podrán hacer un seguimiento de sus gastos y hábitos de consumo, sino que también proporcionará al supermercado datos cruciales para mejorar su oferta y estrategias de marketing.

Con varios tickets ya disponibles para comenzar nuestro trabajo y con la ayuda del notebook de Python ‘TicketPDF2TXT.ipynb’, estamos listos para transformar los datos de los tickets en formato PDF a texto, lo que nos permitirá procesar y analizar la información de manera eficiente. A medida que agreguemos más tickets a nuestra base de datos, nuestro programa se enriquecerá, ofreciendo una visión más amplia y precisa del comportamiento del consumidor.


```{r}
#Cargamos las librerias necesarias.
library(hms)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
#Creamos una función que nos permita transformar el fichero txt a un dataframe
#con las variables que nos serán útiles para responder a las preguntas
conjunto_de_datos <- function(path){
#Leemos todas las líneas del fichero
ticket <- readLines(path)
#Asignamos las variables 
cantidad <- c()
descripcion <- c()
precio <- c()
lineas <- readLines(path)
cantidad_lineas <- length(lineas)
m <- c("A", "B", "C", "D", "E", "F", "G", "H", "I",
                       "J", "K", "L", "M", "N", "O", "P", "Q", "R",
                       "S", "T", "U", "V", "W", "X", "Y", "Z")


# n será el contador de la línea que se está procesando
n <- 1
# s es una variable que nos permitirá identificar los alimentos a peso
s <- 0
#Creamos un bucle for que vaya linea por línea
for (linea in ticket){
  #Comprobamos que la línea no esté vacía 
  if (!is.null(linea)){
    #Convertimos la línea para que los acentos y Ñ no nos de problemas
    linea <- iconv(linea, "latin1", "ASCII", sub = "")
    linea <- gsub("Ñ", "N", linea)
    #En la linea 2 de todos los tickets siempre estará la calle
    if (n == 2){
      calle <- linea
      # En la linea 3 el código postal
    } else if (n == 3){
      cod <- linea
      #En la línea 5 la fecha 
    } else if (n == 5){
      #Extraemos solo los 16 primeros caracteres y separamos la fecha de la hora
      linea_fech <- substr(linea,1,16)
      linea_fech1 <- strsplit(linea_fech," ")
      fecha <- linea_fech1[[1]][1]  
      hora <- linea_fech1[[1]][2]
      #Buscamos la lineas con los patrones necesarios y paramos cuando leamos la
      # cantidad de lineas totales - 7, ya que allí es donde ya no hay más
      #alimentos
    } else if (grepl("^\\d", linea) & !grepl("kg|€|21%|10%", linea) &
               n != cantidad_lineas - 7){
      #Extraemos la cantidad y la añadimos a nuestro vector.Hacemos el mismo
      #proceso para la descripción(el producto)
      cant <- as.numeric(regmatches(linea, regexec("\\d", linea))[[1]])
      cantidad <- c(cantidad,cant)
      
      descrip <- gsub("^\\d+\\s*", "", linea)
      descrip <- gsub("\\s*\\d+(,\\d+)?$", "", descrip)
      
      descripcion <- c(descripcion,descrip)
      #Para los precios diferenciamos si se trata de un producto a precio o no
      linea <- strsplit(linea, "\\s+")[[1]]
      prec <- linea[length(linea)]
      prir <- substr(prec, 3, 3)
      if (prir %in% m){
        s <- 1
      } else {
        #Si no es a peso guardamos el precio directamente
        s <- 0
        precio <- c(precio,prec)
      }
    } else if (s == 1){
      #Guardamo el precio de los productos a peso(es último número)
      elementos <- strsplit(linea, " ")[[1]]
      numero <- elementos[length(elementos)]
      precio <- c(precio,numero)
      s <- 0
      #Extraemos el método de pago, siempre se encuentra en la misma posición
    } else if (n == cantidad_lineas - 5){
      pago <- sub(":.*", "", linea)
    }
  }
  n <- n + 1
}
#Aquellas variables con un solo valor las repetimos para poder crear el dataframe
vector_cod <- rep(cod, times = length(descripcion))
vector_calle <- rep(calle, times = length(descripcion))
vector_hora <- rep(hora, times = length(descripcion))
vector_fecha <- rep(fecha, times = length(descripcion))
vector_pago <- rep(pago, times = length(descripcion))
df <- data.frame(Alimento = descripcion,Cantidad = cantidad, Precio = precio,
                 hora = hora,
                 fecha = fecha, calle = calle, codigo = cod, Pago = pago)
#Convertimos el precio a variable nuérica
df$Precio <- as.numeric(gsub(",", ".", df$Precio))
df$Precio <- as.numeric(df$Precio)
#El bucle también coge el tipo impósitivo, por lo que los eliminamos
df <- subset(df, !grepl("^%", df$Alimento))
return(df)
}
#Crgamos todos los tickets
ticket1<-"data/20231218 Mercadona 60,47 Ôé¼.txt"
ticket2<-"data/20231224 Mercadona 37,49 Ôé¼.txt"
ticket3<-"data/20231226 Mercadona 25,83 Ôé¼.txt"
ticket4<-"data/20231230 Mercadona 66,30 Ôé¼.txt"
ticket5<-"data/20240102 Mercadona 70,04 Ôé¼.txt"
ticket6<-"data/20240108 Mercadona 83,73 Ôé¼.txt"
ticket7<-"data/20240109 Mercadona 7,35 Ôé¼.txt"
ticket8<-"data/20240111 Mercadona 41,20 Ôé¼.txt"
ticket9<-"data/20240115 Mercadona 117,41 Ôé¼.txt"
ticket10<-"data/20240123 Mercadona 44,13 Ôé¼.txt"
ticket11<-"data/20240127 Mercadona 108,33 Ôé¼.txt"
ticket12<-"data/20240131 Mercadona 16,82 Ôé¼.txt"
ticket13<-"data/20240326 Mercadona 13,03 Ôé¼.txt"
ticket14<-"data/20240309 Mercadona 96,87 Ôé¼.txt"
ticket15<-"data/20240213 Mercadona 16,73 Ôé¼.txt"
ticket16<-"data/20240313 Mercadona 4,50 Ôé¼.txt"
ticket17<-"data/20240316 Mercadona 51,42 Ôé¼.txt"
ticket18<-"data/20240318 Mercadona 16,59 Ôé¼.txt"
ticket19<-"data/20240320 Mercadona 12,11 Ôé¼.txt"
ticket20<-"data/20240307 Mercadona 39,45 Ôé¼.txt"
#Los guardamos en un data frame
df_ticket1 <- conjunto_de_datos(ticket1)
df_ticket2<- conjunto_de_datos(ticket2)
df_ticket3 <- conjunto_de_datos(ticket3)
df_ticket4 <- conjunto_de_datos(ticket4)
df_ticket5 <- conjunto_de_datos(ticket5)
df_ticket6 <- conjunto_de_datos(ticket6)
df_ticket7 <- conjunto_de_datos(ticket7)
df_ticket8 <- conjunto_de_datos(ticket8)
df_ticket9 <- conjunto_de_datos(ticket9)
df_ticket10 <- conjunto_de_datos(ticket10)
df_ticket11<- conjunto_de_datos(ticket11)
df_ticket12<- conjunto_de_datos(ticket12)
df_ticket13<- conjunto_de_datos(ticket13)
df_ticket14<- conjunto_de_datos(ticket14)
df_ticket15<- conjunto_de_datos(ticket15)
df_ticket16<- conjunto_de_datos(ticket16)
df_ticket17<- conjunto_de_datos(ticket17)
df_ticket18<- conjunto_de_datos(ticket18)
df_ticket19<- conjunto_de_datos(ticket19)
df_ticket20<- conjunto_de_datos(ticket20)
```



```{r, echo=FALSE}

library(bookdown)
library(knitr)
library(kableExtra)
# Crear un dataframe
tabla <- data.frame(
  Variables = c("Producto",
                "Canitidad",
                "Precio",
                "Hora",
                "Fecha",
                "Calle",
                "Código postal",
                "Método de pago"
                ),
  Descripción = c("El producto que se compró",
                  "Unidades que se compraron",
                  "Coste del producto",
                  "Hora de la compra",
                  "Fecha de la compra",
                  "Localización de la tienda",
                  "Código postal de la tienda",
                  "Método de pago utilizado"),
  Ejemplo = c("BERENJENA",
              "1",
              "1.30",
              "19:30",
              "09/01/2024",
              "C/ MENORCA (C.C. AQUA) 19",
              "46023 VALENCIA",
              "TARJ. BANCARIA")
)

```



# Preguntas

Una vez que hemos garantizado que nuestros datos se encuentran en la estructura adecuada, podemos comenzar a explorar posibles patrones y tendencias que puedan surgir de nuestra información.

Tras un detallado análisis de los datos, hemos dado con una serie de preguntas que nos resultarán muy útiles para nuestro proyecto.

Para responder a las siguientes preguntas usaremos tan solo las variables de interés.Las podemos observar en 
esta tabla

Tabla 1. Variables que emplearemos
```{r, echo=FALSE}
knitr::kable(tabla, booktabs = TRUE)
```


**Cambio de Precio:** ¿Qué productos son los que más cambian de precio? ¿Existen productos con precios más estables que otros?

**Productos Populares:** ¿Cuáles son los productos más comprados en general? ¿Algunos productos son adquiridos con mayor frecuencia que otros?

**Hora de Compra:** ¿Existe una hora del día más popular para realizar compras? ¿Cómo varía el comportamiento de compra a lo largo del día?

**Método de Pago:** ¿Qué método de pago es el más popular en los clientes? ¿Los clientes que utilizan ciertos métodos de pago tienden a gastar más o menos que aquellos que utilizan otros métodos?

**Precios de los alimentos:**¿Cuáles son los alimentos más caros?¿Y los más baratos?

**Zonas de compra:** ¿Cuál es la distribución geográfica de las compras realizadas?

**Gasto promedio:** ¿Cuál es el promedio de gasto por compra?

**Precio - Cantidad vendida:** ¿Existe alguna correlación entre el precio de los productos y la cantidad vendida?
