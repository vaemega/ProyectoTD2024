---
title: "ProyectoTD2024"
author: "Sergio Taengua Díaz, Valentina Elisa Medina Gallazzi, Narcis Casian Romega, Sheida Zolfaghari"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

En la era actual, donde la digitalización y la sostenibilidad son de suma importancia, la implementación de tickets electrónicos por parte de un conocido supermercado representa un avance significativo. Este cambio no solo promueve la reducción del uso de papel, sino que también abre un nuevo horizonte de posibilidades en el análisis de datos de consumo. Como estudiantes del GCD, nos enfrentamos al desafío de desarrollar un programa que no solo simplifique la transición a lo digital, sino que también permita un análisis exhaustivo de los hábitos de compra.

Nuestro objetivo es crear una herramienta que analice los tickets electrónicos para obtener información valiosa sobre la evolución de precios, las compras más habituales, los productos más consumidos, el supermercado preferido por los clientes y la hora de compra, entre otros aspectos. Este análisis no solo beneficiará a los consumidores, quienes podrán hacer un seguimiento de sus gastos y hábitos de consumo, sino que también proporcionará al supermercado datos cruciales para mejorar su oferta y estrategias de marketing.

Con varios tickets ya disponibles para comenzar nuestro trabajo y con la ayuda del notebook de Python ‘TicketPDF2TXT.ipynb’, estamos listos para transformar los datos de los tickets en formato PDF a texto, lo que nos permitirá procesar y analizar la información de manera eficiente. A medida que agreguemos más tickets a nuestra base de datos, nuestro programa se enriquecerá, ofreciendo una visión más amplia y precisa del comportamiento del consumidor.

```{r}
library(hms)
library(readr)
library(dplyr)
library(tidyr)
conjunto_de_datos <- function(path){
  ticket <- readLines(path)
cantidad <- c()
descripcion <- c()
alimento <- c()
precio <- c()
lineas <- readLines(path)
cantidad_lineas <- length(lineas)
m <- c("A", "B", "C", "D", "E", "F", "G", "H", "I",
                       "J", "K", "L", "M", "N", "O", "P", "Q", "R",
                       "S", "T", "U", "V", "W", "X", "Y", "Z")

n <- 1
s <- 0

for (linea in ticket){
  if (!is.null(linea)){
    linea <- iconv(linea, "latin1", "ASCII", sub = "")
    linea <- gsub("Ñ", "N", linea)
    
    if (n == 2){
      calle <- linea
      
    } else if (n == 3){
      cod <- linea
      
    } else if (n == 5){
      linea_fech <- substr(linea,1,16)
      linea_fech1 <- strsplit(linea_fech," ")
      fecha <- linea_fech1[[1]][1]  
      hora <- linea_fech1[[1]][2] 
    } else if (grepl("^\\d", linea) & !grepl("kg|€|21%|10%", linea) & n != cantidad_lineas - 7){
      cant <- as.numeric(regmatches(linea, regexec("\\d", linea))[[1]])
      cantidad <- c(cantidad,cant)
      
      descrip <- gsub("^\\d+\\s*", "", linea)
      descrip <- gsub("\\s*\\d+(,\\d+)?$", "", descrip)
      
      descripcion <- c(descripcion,descrip)
      linea <- strsplit(linea, "\\s+")[[1]]
      prec <- linea[length(linea)]
      print(prec)
      prir <- substr(prec, 3, 3)
      if (prir %in% m){
        s <- 1
        print("hola")
      } else {
        s <- 0
        precio <- c(precio,prec)
      }
    } else if (grepl("TARJETA BANCARIA", linea)){
      metodo_pago <- regmatches(linea, regexec("TARJETA (DE )?PAGO", linea))[[1]]
      s <- 0
    } else if (s == 1){
      elementos <- strsplit(linea, " ")[[1]]
      numero <- elementos[length(elementos)]
      precio <- c(precio,numero)
      print(numero)
      s <- 0
    }
  }
  n <- n + 1
}

vector_cod <- rep(cod, times = length(descripcion))
vector_calle <- rep(calle, times = length(descripcion))
vector_hora <- rep(hora, times = length(descripcion))
vector_fecha <- rep(fecha, times = length(descripcion))
df <- data.frame(Alimento = descripcion,Cantidad = cantidad, Precio = precio, hora = hora,
                 fecha = fecha, calle = calle, codigo = cod)
df$Precio <- as.numeric(gsub(",", ".", df$Precio))
df$Precio <- as.numeric(df$Precio)
return(df)
}
s <- "data/20240102 Mercadona 70,04 Ôé¼.txt"
df_s <- conjunto_de_datos(s)
df_s %>% summarise(suma = sum(df_s$Precio))
```

# Preguntas

Una vez que hemos garantizado que nuestros datos se encuentran en la estructura adecuada, podemos comenzar a explorar posibles patrones y tendencias que puedan surgir de nuestra información.

Tras un detallado análisis de los datos, hemos dado con una serie de preguntas que nos resultarán muy útiles para nuestro proyecto.

**Cambio de Precio**: ¿Qué productos son los que más cambian de precio? ¿Existen productos con precios más estables que otros?

**Productos Populares**: ¿Cuáles son los productos más comprados en general? ¿Algunos productos son adquiridos con mayor frecuencia que otros?

**Hora de Compra**: ¿Existe una hora del día más popular para realizar compras? ¿Cómo varía el comportamiento de compra a lo largo del día?

**Método de Pago:** ¿Qué método de pago es el más popular en los clientes? ¿Los clientes que utilizan ciertos métodos de pago tienden a gastar más o menos que aquellos que utilizan otros métodos?
