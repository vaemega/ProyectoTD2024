---
title: "ProyectoTD2024"
subtitle: Tratamiento de Datos. Grado en Ciencia de Datos- UV
author: Sergio Taengua Díaz, Valentina Elisa Medina Gallazzi, Narcis Casian Romega,
  Sheida Zolfaghari
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introducción

En la era actual, donde la digitalización y la sostenibilidad son de suma importancia, la implementación de tickets electrónicos por parte de un conocido supermercado representa un avance significativo. Este cambio no solo promueve la reducción del uso de papel, sino que también abre un nuevo horizonte de posibilidades en el análisis de datos de consumo. Como estudiantes del GCD, nos enfrentamos al desafío de desarrollar un programa que no solo simplifique la transición a lo digital, sino que también permita un análisis exhaustivo de los hábitos de compra.

Nuestro objetivo es crear una herramienta que analice los tickets electrónicos para obtener información valiosa sobre la evolución de precios, las compras más habituales, los productos más consumidos, el supermercado preferido por los clientes y la hora de compra, entre otros aspectos. Este análisis no solo beneficiará a los consumidores, quieciñnes podrán hacer un seguimiento de sus gastos y hábitos de consumo, sino que también proporcionará al supermercado datos cruciales para mejorar su oferta y estrategias de marketing.

Con varios tickets ya disponibles para comenzar nuestro trabajo y con la ayuda del notebook de Python 'TicketPDF2TXT.ipynb', estamos listos para transformar los datos de los tickets en formato PDF a texto, lo que nos permitirá procesar y analizar la información de manera eficiente. A medida que agreguemos más tickets a nuestra base de datos, nuestro programa se enriquecerá, ofreciendo una visión más amplia y precisa del comportamiento del consumidor.

# 1.1. Carga de librerías y datos necesarios para el análisis

Primeramente, se cargan todas las librerias necesarias para poder analizar correctamente nuestro conjunto de datos.

```{r include=FALSE}
#Cargamos las librerias necesarias.
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load(hms,readr,dplyr,tidyr,ggplot2)
```

# 1.2. Características generales de los datos

Podemos hacernos a la idea de las características generales de los datos utilizando funciones como glimpse, head, str, dim, is.na...

En resumen, nuestro conjunto de datos está formado por 315 observaciones y 15 variables.

```{r echo=TRUE, warning=FALSE}
glimpse(observaciones)
head(observaciones)
dim(observaciones)
str(observaciones)
is.na(observaciones)
```

Tabla 1.Variables de interés para el estudio de los datos.

| Variables      | Descripción |
|----------------|-------------|
| Identificacion |             |
| Age            |             |
|                |             |

```{r echo=TRUE, warning=FALSE}
#Creamos una función que nos permita transformar el fichero txt a un dataframe
#con las variables que nos serán útiles para responder a las preguntas
#Inicializamos las variables con valores por defecto
HoraEntrada <- NA
HoraSalida <- NA
PrecioParking <- NA
conjunto_de_datos <- function(path){
#Leemos todas las líneas del fichero
ticket <- readLines(path)
#Asignamos las variables 
cantidad <- c()
descripcion <- c()
precio <- c()
PrecioParking <- NA
lineas <- readLines(path)
cantidad_lineas <- length(lineas)
m <- c("A", "B", "C", "D", "E", "F", "G", "H", "I",
                       "J", "K", "L", "M", "N", "O", "P", "Q", "R",
                       "S", "T", "U", "V", "W", "X", "Y", "Z")


# n será el contador de la línea que se está procesando
n <- 1
# s es una variable que nos permitirá identificar los alimentos a peso
s <- 0
#Creamos un bucle for que vaya linea por línea
for (linea in ticket){
  #Comprobamos que la línea no esté vacía 
  if (!is.null(linea)){
    #Convertimos la línea para que los acentos y Ñ no nos de problemas
    linea <- iconv(linea, "latin1", "UTF-8", sub = "")
    #En la linea 2 de todos los tickets siempre estará la calle
    if (n == 2){
      Direccion <- linea
      # En la linea 3 el código postal
    } else if (n == 3){
      cod <- linea
      #En la línea 5 la fecha 
    } else if (n == 5){
      #Extraemos solo los 16 primeros caracteres y separamos la fecha de la hora
      linea_fech <- substr(linea,1,16)
      linea_fech1 <- strsplit(linea_fech," ")
      FechaCompra <- linea_fech1[[1]][1]  
      HoraCompra <- linea_fech1[[1]][2]
      #Buscamos la líneas con los patrones necesarios y paramos cuando leamos la
      # cantidad de lineas totales - 7, ya que allí es donde ya no hay más
      #alimentos
    } else if (grepl("1PARKING", linea)){
        # Extraemos el precio del parking
        elementos <- strsplit(linea, " ")[[1]]
        PrecioParking <- as.numeric(gsub(",", ".", elementos[length(elementos)]))
    } else if (grepl("^\\d", linea) & !grepl("kg|€|21%|10%", linea) &
               n != cantidad_lineas - 7){
      #Extraemos la cantidad y la añadimos a nuestro vector.Hacemos el mismo
      #proceso para la descripción(el producto)
      cant <- as.numeric(regmatches(linea, regexec("\\d", linea))[[1]])
      cantidad <- c(cantidad,cant)
      
      descrip <- gsub("^\\d+\\s*", "", linea)
      descrip <- gsub("\\s*\\d+(,\\d+)?$", "", descrip)
      
      descripcion <- c(descripcion,descrip)
      #Para los precios diferenciamos si se trata de un producto a granel o no
      linea <- strsplit(linea, "\\s+")[[1]]
      prec <- linea[length(linea)]
      prir <- substr(prec, 3, 3)
      if (prir %in% m){
        s <- 1
      } else {
        #Si no es a peso guardamos el precio directamente
        s <- 0
        precio <- c(precio,prec)
      }
    } else if (s == 1){
      #Guardamos el precio de los productos a peso (corresponde al último número)
      elementos <- strsplit(linea, " ")[[1]]
      numero <- elementos[length(elementos)]
      precio <- c(precio,numero)
      s <- 0
      #Extraemos el método de pago, siempre se encuentra en la misma posición
    } else if (n == cantidad_lineas - 5){
      MetodoPago <- sub(":.*", "", linea)
    } else if (grepl("ENTRADA", linea)){
      partes <- unlist(strsplit(linea, "\\s+"))
      HoraEntrada <- partes[2]
      HoraSalida <- partes[4]
    }
  }
  n <- n + 1
}
#Aquellas variables con un solo valor las repetimos para poder crear el dataframe
vector_cod <- rep(cod, times = length(descripcion))
vector_calle <- rep(Direccion, times = length(descripcion))
vector_hora <- rep(HoraCompra, times = length(descripcion))
vector_fecha <- rep(FechaCompra, times = length(descripcion))
vector_pago <- rep(MetodoPago, times = length(descripcion))
vector_entrada <- rep(HoraEntrada, times = length(descripcion))
vector_salida <- rep(HoraSalida, times = length(descripcion))
vector_precio_parking <- rep(PrecioParking, times = length(descripcion))
df <- data.frame(Alimento = descripcion, Cantidad = cantidad, Precio = precio, HoraCompra = HoraCompra, FechaCompra = FechaCompra, Direccion = Direccion, codigo = cod, MetodoPago = MetodoPago, HoraEntrada = vector_entrada, HoraSalida = vector_salida, PrecioParking = vector_precio_parking)
#Convertimos el precio a variable numérica
df$Precio <- as.numeric(gsub(",", ".", df$Precio))
df$Precio <- as.numeric(df$Precio)
#El bucle también coge el tipo impositivo, por lo que los eliminamos
df <- subset(df, !grepl("^%", df$Alimento))
df <- df %>%
  mutate(CodigoPostal = sub(" .*", "", codigo), #Extraemos el código postal
         Ciudad = sub("^[0-9]+ ", "", codigo))   #Extraemos la ciudad
# Eliminamos la variable 'codigo' del dataframe
df <- df %>%
  select(-codigo)
return(df)
}
#Cargamos todos los tickets
path <- "data/"


#Obtenemos una lista de todos los archivos .txt en la carpeta
files <- list.files(path, pattern = "[.]txt$", full.names = TRUE)

# Procesamos todos los archivos y combinamos los resultados
observaciones <- bind_rows(lapply(files, conjunto_de_datos), .id = "ticket_id")

#Creamos la variable Parking para ver qué personas han usado el
#aparcamiento del supermercado


ids_con_parking <- unique(observaciones$ticket_id[observaciones$Alimento ==
                                                    "PARKING"])

#Obtenemos los tickets que han usado o no el aparcamiento
observaciones <- observaciones %>%
  mutate(Parking = ifelse(!is.na(HoraEntrada) & !is.na(HoraSalida), "SI", "NO"))

observaciones <- observaciones %>% filter(Alimento != "PARKING")
observaciones[,"ticket_id"] <- sapply(observaciones[,"ticket_id"],as.numeric)  
```

```{r include=FALSE}

library(bookdown)
library(knitr)
library(kableExtra)
# Crear un dataframe
tabla <- data.frame(
  Variables = c("Producto",
                "Cantidad",
                "Precio",
                "Hora",
                "Fecha",
                "Calle",
                "Código postal",
                "Método de pago"
                ),
  Descripción = c("El producto que se compró",
                  "Unidades que se compraron",
                  "Coste del producto",
                  "Hora de la compra",
                  "Fecha de la compra",
                  "Localización de la tienda",
                  "Código postal de la tienda",
                  "Método de pago utilizado"),
  Ejemplo = c("BERENJENA",
              "1",
              "1.30",
              "19:30",
              "09/01/2024",
              "C/ MENORCA (C.C. AQUA) 19",
              "46023 VALENCIA",
              "TARJ. BANCARIA")
)
```

# Preguntas

Una vez que hemos garantizado que nuestros datos se encuentran en la estructura adecuada, podemos comenzar a explorar posibles patrones y tendencias que puedan surgir de nuestra información.

Tras un detallado análisis de los datos, hemos dado con una serie de preguntas que nos resultarán muy útiles para nuestro proyecto.

**Cambio de Precio:** ¿Qué productos son los que más cambian de precio? ¿Existen productos con precios más estables que otros?

**Productos Populares:** ¿Cuáles son los productos más comprados en general? ¿Algunos productos son adquiridos con mayor frecuencia que otros?

```{r include=FALSE}
#observamos los productos más comprados en general
#productos_populares <- observaciones %>% group_by(Alimento) %>% summarise(Cantidad_Total = sum(Cantidad)) %>% arrange(desc(Cantidad_Total))
#la frecuencia 
#productos_frecuentes <- observaciones %>%
  #  group_by(Alimento) %>%
   # summarise(Frecuencia_Compra = n()) %>%
   # arrange(desc(Frecuencia_Compra))


```

**Hora de Compra:** ¿Existe una hora del día más popular para realizar compras? ¿Cómo varía el comportamiento de compra a lo largo del día?

**Parking:** ¿Cuánta gente usa el aparcamiento del supermercado?¿Cuánto dinero paga la gente por este servicio?

```{r}
#Gráfico para observar cuánta gente usa el aparcamiento, contando un único uso por ticket_id

uso_parking_total <- observaciones %>%
  group_by(Parking) %>%
  summarise(Count = n_distinct(ticket_id))

ggplot(uso_parking_total, aes(x = Parking, y = Count, fill = Parking)) +
  geom_bar(stat = "identity") +
  labs(title = "Uso del Aparcamiento del Supermercado",
       x = "Aparcamiento Utilizado",
       y = "Cantidad de Tickets") +
  theme_minimal()
```

```{r}
#Nos aseguramos de que 'HoraEntrada' esté en el formato correcto y no sea NA
observaciones <- observaciones %>%
  filter(!is.na(HoraEntrada)) %>%
  mutate(HoraEntrada = as.POSIXct(HoraEntrada, format = "%H:%M"))

#Creamos un factor con los intervalos horarios
observaciones$Intervalo <- cut(observaciones$HoraEntrada,
                               breaks = as.POSIXct(c("09:00", "12:00", "15:00", "18:00", "21:30"), format = "%H:%M"),
                               labels = c("9:00-12:00", "12:00-15:00", "15:00-18:00", "18:00-21:30"),
                               include.lowest = TRUE)

#Contamos cada ticket una sola vez
observaciones_unicas <- observaciones %>%
  group_by(ticket_id, Intervalo) %>%
  summarise(n = n_distinct(ticket_id))

#Creamos el gráfico
ggplot(observaciones_unicas, aes(x = Intervalo, y = n, fill = Intervalo)) +
  geom_histogram(stat = "identity") +
  xlab("Intervalo Horario") +
  ylab("Cantidad de Tickets") +
  ggtitle("Hora de Entrada al Parking") +
  theme_minimal() +
  theme(legend.position = "none")

```

**Método de Pago:** ¿Qué método de pago es el más popular en los clientes? ¿Los clientes que utilizan ciertos métodos de pago tienden a gastar más o menos que aquellos que utilizan otros métodos?

**Precios de los alimentos:**¿Cuáles son los alimentos más caros?¿Y los más baratos?

**Zonas de compra:** ¿Cuál es la distribución geográfica de las compras realizadas?

**Gasto promedio:** ¿Cuál es el promedio de gasto por compra?

```{r echo=FALSE}
num_tickets <- length(unique(observaciones[,"ticket_id"]))
media_compra <- sum(observaciones[,"Precio"]) / num_tickets
data_compra <- observaciones[,c('ticket_id','Precio')]
data_compra <- data_compra %>%
  group_by(ticket_id) %>%
  mutate(Precio = sum(Precio))
data_compra<-unique(data_compra)

data_compra %>%
  ggplot(aes(x =reorder(ticket_id,-Precio),y = Precio,group = ticket_id)) +
  geom_point(colour = "red") +
  geom_hline(yintercept= media_compra,
             color="black",
             lwd=1,
             linetype = "dashed") +
  labs(title = "Precio de compra de cada ticket",
       x = "Identificador del ticket",
       y = "Precio de la compra") +
  annotate("text", x= 18, y=4+media_compra, label=paste0('Media compras'))
```

**Precio - Cantidad vendida:** ¿Existe alguna correlación entre el precio de los productos y la cantidad vendida?

```{r echo=FALSE}
precio_cantidad <- observaciones[,c("Alimento","Cantidad","Precio")]
precio_cantidad <- precio_cantidad %>% mutate(PrecioUnidad = Precio / Cantidad)
cor(precio_cantidad[,c("Cantidad","PrecioUnidad")], method = "spearman")
```

Para responder a estas preguntas usaremos tan solo las variables de interés.Las podemos observar en esta tabla

```{r Table 1, echo=FALSE, fig.align='center', fig.cap='Figura 1: Variables empleadas', out.width='60%'}
knitr::kable(tabla, booktabs = TRUE,caption = 'Variables empleadas')
```

**Zonas de compra:** ¿Cuál es la distribución geográfica de las compras realizadas?

```{r echo=TRUE, warning=FALSE}
#Primero compruebo si la dirección es un carácter:
class(observaciones$Ciudad)
#He hecho esta comprobación porque dependiendo el tipo de variable hay que hacer un gráfico u otro.
ggplot(data = observaciones) +  geom_bar(mapping = aes(x = Ciudad, fill = Ciudad)) + (labs(x = "Ciudades", y = "Compras",
   title = "Distribución geográfica de las compras"))  +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

**Hora más frecuente:** ¿Cuál es la hora más común de compra?

```{r}
#Primero observo de que tipo es la variable "HoraCompra":
class(observaciones$HoraCompra)

ggplot(data = observaciones) +  geom_bar(mapping = aes(x = HoraCompra, fill = HoraCompra)) + (labs(x = "Hora de compra", y = "Compras",
   title = "Distribución horaria compras"))


```

En la figura \@ref(fig:Table 1).
